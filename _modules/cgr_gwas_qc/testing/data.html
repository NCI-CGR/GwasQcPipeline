

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>cgr_gwas_qc.testing.data &mdash; GwasQcPipeline 1.5.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> GwasQcPipeline
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/installation.html">Installing GwasQcPipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/running_pipeline.html">Running the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/configuration.html">Configuration Files</a></li>
</ul>
<p><span class="caption-text">QC Sub Workflows</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../sub_workflows/entry_points.html">Entry Points Sub-workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sub_workflows/contamination.html">Contamination Sub-workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sub_workflows/sample_qc.html">Sample QC Sub-workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sub_workflows/subject_qc.html">Subject QC Sub-workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sub_workflows/delivery.html">Delivery Sub-workflow</a></li>
</ul>
<p><span class="caption-text">User Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/file_types.html">File Type Reference</a></li>
</ul>
<p><span class="caption-text">Developer Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../dev_docs/setup.html">Development Environment Set-up</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev_docs/documentation.html">Working with Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev_docs/source_code.html">Working with Source Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev_docs/testing.html">Working with Test Suite</a></li>
</ul>
<p><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/cgr_gwas_qc.html">API Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">GwasQcPipeline</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>cgr_gwas_qc.testing.data</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for cgr_gwas_qc.testing.data</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Testing data access.</span>

<span class="sd">The goal of this module is to make test data easily accessible in fixtures</span>
<span class="sd">and tests. Here we are hiding some of the complexity and provide a simple API</span>
<span class="sd">for copying test data into a working directory and creating a config.yml.</span>

<span class="sd">Currently, we have two sources for test data ``TestData`` and ``RealData``.</span>

<span class="sd">The ``TestData`` contains a set of very small test datasets that I collected</span>
<span class="sd">from the internet. These data are ideal for testing specific functionality</span>
<span class="sd">like converting file types and running upstream parts of the workflow.</span>
<span class="sd">However, the data are synthetic so they will not work with filtering steps</span>
<span class="sd">and various parts of the workflow.</span>

<span class="sd">The ``RealData`` contains ~200 real samples. These data are potentially</span>
<span class="sd">re-identifiable so they cannot be distributed outside of the network.</span>
<span class="sd">However, because they are real data they will behave well for testing</span>
<span class="sd">filtering steps and downstream parts of the workflow. This data also includes</span>
<span class="sd">all outputs for these samples from the Production workflow. This will allow</span>
<span class="sd">regression testing of most parts of the workflow.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">MutableMapping</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>

<span class="kn">from</span> <span class="nn">cgr_gwas_qc.cli.pre_flight</span> <span class="kn">import</span> <span class="n">update_sample_sheet</span>
<span class="kn">from</span> <span class="nn">cgr_gwas_qc.models.config.reference_files</span> <span class="kn">import</span> <span class="n">ReferenceFiles</span>
<span class="kn">from</span> <span class="nn">cgr_gwas_qc.models.config.software_params</span> <span class="kn">import</span> <span class="n">SoftwareParams</span>
<span class="kn">from</span> <span class="nn">cgr_gwas_qc.models.config.user_files</span> <span class="kn">import</span> <span class="n">UserFiles</span>
<span class="kn">from</span> <span class="nn">cgr_gwas_qc.models.config.workflow_params</span> <span class="kn">import</span> <span class="n">WorkflowParams</span>
<span class="kn">from</span> <span class="nn">cgr_gwas_qc.parsers.sample_sheet</span> <span class="kn">import</span> <span class="n">SampleManifest</span>
<span class="kn">from</span> <span class="nn">cgr_gwas_qc.testing</span> <span class="kn">import</span> <span class="n">make_snakefile</span><span class="p">,</span> <span class="n">make_test_config</span>

<span class="n">DEFAULT_TEST_DATA_SERVER</span> <span class="o">=</span> <span class="s2">&quot;cgemsiii.nci.nih.gov&quot;</span>
<span class="n">DEFAULT_TEST_DATA_PATH</span> <span class="o">=</span> <span class="s2">&quot;/DCEG/CGF/Bioinformatics/Production/data/cgr_gwas_qc/test_data&quot;</span>

<span class="c1"># This is a trick to add a type annotation that says that the method is</span>
<span class="c1"># returning the class itself. This will magically update to the subclass too.</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s2">&quot;DataRepo&quot;</span><span class="p">)</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;DataRepo&quot;</span><span class="p">,</span> <span class="n">T</span><span class="p">]</span>  <span class="c1"># I had to use the Union instead of `T` to get mypy to pass</span>


<span class="k">class</span> <span class="nc">DataRepo</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract Base Class for Test Data.</span>

<span class="sd">    My goal is to create a set of classes to easily copy test datasets to the</span>
<span class="sd">    test&#39;s working directory. The general functionality is very similar for</span>
<span class="sd">    different sources of tests so I opted to use class inheritance instead of</span>
<span class="sd">    duplicating code/logic.</span>

<span class="sd">    Similar to a regular class, an Abstract Base Class (ABC), allows you to</span>
<span class="sd">    create attributes/properties that are inheritable by subclasses. However,</span>
<span class="sd">    the ABC also allows you to define the attributes/methods that your</span>
<span class="sd">    subclasses need but not implement them.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Required Class Attributes, make sure to define in your subclass.</span>
    <span class="n">_data_type</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># This will be the `project_name` in the config</span>
    <span class="n">_data_path</span><span class="p">:</span> <span class="n">Path</span>  <span class="c1"># Path to the data repository</span>
    <span class="n">_sample_sheet</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># name of the sample sheet relative to the data repository</span>
    <span class="n">_illumina_manifest_file</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># name of the BPM file</span>
    <span class="n">_thousand_genome_vcf</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># name of the VCF file</span>
    <span class="n">_thousand_genome_tbi</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># name of the VCF.TBI file</span>
    <span class="n">_gtc_pattern</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># GTC file name pattern</span>
    <span class="n">_idat_red_pattern</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># Red IDAT file name pattern</span>
    <span class="n">_idat_green_pattern</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># Green IDAT file name pattern</span>
    <span class="n">_ped</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># Name of the aggregate samples PED</span>
    <span class="n">_map</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># Name of the aggregate samples MAP</span>
    <span class="n">_bed</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># Name of the aggregate samples BED</span>
    <span class="n">_bim</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># Name of the aggregate samples BIM</span>
    <span class="n">_fam</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># Name of the aggregate samples FAM</span>
    <span class="n">_num_snps</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># Number of SNPs in the array</span>
    <span class="n">_subject_id_column</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># The column containing subject information</span>
    <span class="n">_expected_sex_column</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># The column containing sex information</span>
    <span class="n">_case_control_column</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># The column containing Case/Control information</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">working_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">=</span> <span class="n">working_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ss</span> <span class="o">=</span> <span class="n">SampleManifest</span><span class="p">(</span><span class="bp">self</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_sheet</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">:</span> <span class="n">MutableMapping</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;project_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;Project Name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;snp_array&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">manifests</span><span class="p">[</span><span class="s2">&quot;snp_array&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;num_snps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_snps</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;sample_sheet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_sheet</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;num_samples&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;reference_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ReferenceFiles</span><span class="p">(</span>
            <span class="n">illumina_manifest_file</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_illumina_manifest_file</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">(),</span>
            <span class="n">thousand_genome_vcf</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thousand_genome_vcf</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">(),</span>
            <span class="n">thousand_genome_tbi</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thousand_genome_tbi</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">(),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;user_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">UserFiles</span><span class="p">()</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;software_params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SoftwareParams</span><span class="p">()</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;workflow_params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">WorkflowParams</span><span class="p">(</span>
            <span class="n">subject_id_column</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_subject_id_column</span><span class="p">,</span>
            <span class="n">expected_sex_column</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_expected_sex_column</span><span class="p">,</span>
            <span class="n">case_control_column</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_case_control_column</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_add_gtcs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Each subclass must define this method.</span>

<span class="sd">        Handling of copying GTCs is very specific to the source of the test</span>
<span class="sd">        data. So I require that each subclass defines this method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_add_idats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Each subclass must define this method.</span>

<span class="sd">        Handling of copying IDATs is very specific to the source of the test</span>
<span class="sd">        data. So I require that each subclass defines this method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">make_cgr_sample_sheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">U</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse the manifest file and create the cgr sample sheet.</span>

<span class="sd">        Parses the sample manifest and creates a sample sheet saved to</span>
<span class="sd">        ``working_dir/cgr_sample_sheet.csv``. Similar steps are performed</span>
<span class="sd">        during ``cgr preflight``.</span>

<span class="sd">        Args:</span>
<span class="sd">            problem_sample_ids: A list of Sample IDs to mark for exclusion. Defaults to None.</span>
<span class="sd">            kwargs: Any valid ``cgr_gwas_qc.models.config.workflow_params.WorkflowPrams``.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: You must have provided a working directory when</span>
<span class="sd">                        instantiating the object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Creates a file ``working_dir/cgr_sample_sheet.csv`` and returns</span>
<span class="sd">            the ``DataRepo`` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">WorkflowParams</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;workflow_params&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">})</span>
            <span class="n">sample_sheet</span> <span class="o">=</span> <span class="n">SampleManifest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;sample_sheet&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">data</span>
            <span class="n">update_sample_sheet</span><span class="p">(</span>
                <span class="n">sample_sheet</span><span class="p">,</span>
                <span class="n">params</span><span class="o">.</span><span class="n">subject_id_column</span><span class="p">,</span>
                <span class="n">params</span><span class="o">.</span><span class="n">expected_sex_column</span><span class="p">,</span>
                <span class="n">params</span><span class="o">.</span><span class="n">case_control_column</span><span class="p">,</span>
                <span class="p">[],</span>
                <span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">/</span> <span class="s2">&quot;cgr_sample_sheet.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You need to have set ``self.working_dir``.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_user_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_point</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bed&quot;</span><span class="p">,</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">U</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add user provided files.</span>

<span class="sd">        The user files can either be copied into the working directory or</span>
<span class="sd">        have their full path referenced in the config. If a working directory is</span>
<span class="sd">        given (``self.working_dir``) then they will be copied otherwise they</span>
<span class="sd">        will be referenced in the config.</span>

<span class="sd">        Args:</span>
<span class="sd">            entry_point: Which entry point to use (&quot;gtc&quot;, &quot;ped&quot;, or &quot;bed&quot;).</span>
<span class="sd">                            Defaults to &quot;bed&quot;.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="ow">and</span> <span class="n">copy</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_copy_user_files</span><span class="p">(</span><span class="n">entry_point</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_link_user_files</span><span class="p">(</span><span class="n">entry_point</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_link_user_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_point</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># Don&#39;t copy. Add full path to user files in the data repository.</span>
        <span class="k">if</span> <span class="n">entry_point</span> <span class="o">==</span> <span class="s2">&quot;gtc&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;user_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;gtc_pattern&quot;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gtc_pattern</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
                <span class="s2">&quot;idat_pattern&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;red&quot;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idat_red_pattern</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
                    <span class="s2">&quot;green&quot;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idat_green_pattern</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
                <span class="p">},</span>
            <span class="p">}</span>

        <span class="k">elif</span> <span class="n">entry_point</span> <span class="o">==</span> <span class="s2">&quot;ped&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;user_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;ped&quot;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ped</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">(),</span>
                <span class="s2">&quot;map&quot;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">(),</span>
            <span class="p">}</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;user_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;bed&quot;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bed</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">(),</span>
                <span class="s2">&quot;bim&quot;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bim</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">(),</span>
                <span class="s2">&quot;fam&quot;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fam</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">(),</span>
            <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_copy_user_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_point</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">entry_point</span> <span class="o">==</span> <span class="s2">&quot;gtc&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;user_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;gtc_pattern&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gtc_pattern</span><span class="p">,</span>
                <span class="s2">&quot;idat_pattern&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;red&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idat_red_pattern</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idat_green_pattern</span><span class="p">},</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_gtcs</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_idats</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">entry_point</span> <span class="o">==</span> <span class="s2">&quot;ped&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;user_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;ped&quot;</span><span class="p">:</span> <span class="s2">&quot;samples.ped&quot;</span><span class="p">,</span>
                <span class="s2">&quot;map&quot;</span><span class="p">:</span> <span class="s2">&quot;samples.map&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ped</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;user_files&quot;</span><span class="p">][</span><span class="s2">&quot;ped&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_map</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;user_files&quot;</span><span class="p">][</span><span class="s2">&quot;map&quot;</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">entry_point</span> <span class="o">==</span> <span class="s2">&quot;bed&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;user_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;bed&quot;</span><span class="p">:</span> <span class="s2">&quot;samples.bed&quot;</span><span class="p">,</span>
                <span class="s2">&quot;bim&quot;</span><span class="p">:</span> <span class="s2">&quot;samples.bim&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fam&quot;</span><span class="p">:</span> <span class="s2">&quot;samples.fam&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;user_files&quot;</span><span class="p">][</span><span class="s2">&quot;bed&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;user_files&quot;</span><span class="p">][</span><span class="s2">&quot;bim&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;user_files&quot;</span><span class="p">][</span><span class="s2">&quot;fam&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">make_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">U</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a config.yml in ``self.working_dir``.</span>

<span class="sd">        The config.yml will be based on which objects were added using the</span>
<span class="sd">        ``self.add_*`` methods.</span>

<span class="sd">        Args:</span>
<span class="sd">            kwargs: Config options that you would like to set when creating</span>
<span class="sd">              the config.yml</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Update config with passed items</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">:</span>
            <span class="n">make_test_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You need to have set ``self.working_dir``.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">make_snakefile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contents</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">U</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convenience wrapper of ``cgr_gwas_qc.testing.make_snakefile``.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">:</span>
            <span class="n">make_snakefile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">contents</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You need to have set ``self.working_dir``.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">destination</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">U</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy folder or file to a new directory</span>

<span class="sd">        Args:</span>
<span class="sd">            source: The name of a folder or file in the repository</span>
<span class="sd">              ``self._data_path`` that you want to copy to</span>
<span class="sd">              ``self.working_dir``.</span>
<span class="sd">            destination: The name where you want to copy the file or</span>
<span class="sd">              folder in ``self.working_dir``. Default None.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the ``source`` does not exist in the repository.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You need to have set ``self.working_dir``.&quot;</span><span class="p">)</span>

        <span class="n">source_path</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span> <span class="o">/</span> <span class="n">source</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
        <span class="n">destination_path</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">/</span> <span class="n">destination</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
        <span class="n">destination_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Make parent dirs if needed</span>
        <span class="k">if</span> <span class="n">source_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">destination_path</span><span class="p">,</span> <span class="n">copy_function</span><span class="o">=</span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">source_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">destination_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">source_path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="si">}</span><span class="s2"> is not a file or directory.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Override division operator to build paths.&quot;&quot;&quot;</span>
        <span class="n">pth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span> <span class="o">/</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">pth</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">pth</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">pth</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>


<div class="viewcode-block" id="FakeData"><a class="viewcode-back" href="../../../dev_docs/testing.html#cgr_gwas_qc.testing.data.FakeData">[docs]</a><span class="k">class</span> <span class="nc">FakeData</span><span class="p">(</span><span class="n">DataRepo</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A repository of synthetic data stored in ``tests/data``.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; cache = FakeData(working_dir)</span>

<span class="sd">        &gt;&gt;&gt; cache / existing_file.txt  # If file exists then returns path to the file</span>
<span class="sd">        Path(&quot;.../existing_file.txt&quot;)</span>

<span class="sd">        &gt;&gt;&gt; cache / non_existing_file.txt  # If file does not exist then raises exception</span>
<span class="sd">        FileNotFoundError: &quot;.../non_existing_file.txt&quot;</span>

<span class="sd">        &gt;&gt;&gt; cache.make_cgr_sample_sheet()  # copy sample sheet to working dir</span>
<span class="sd">        &gt;&gt;&gt; cache.add_user_files()  # add BED/BIM/FAM to working dir</span>
<span class="sd">        &gt;&gt;&gt; cache.make_config()  # make the config for files added using cache</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_data_type</span> <span class="o">=</span> <span class="s2">&quot;Fake Data&quot;</span>
    <span class="n">_data_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="s2">&quot;tests/data&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>

    <span class="n">_sample_sheet</span> <span class="o">=</span> <span class="s2">&quot;example_sample_sheet.csv&quot;</span>

    <span class="n">_illumina_manifest_file</span> <span class="o">=</span> <span class="s2">&quot;illumina/bpm/small_manifest.bpm&quot;</span>
    <span class="n">_thousand_genome_vcf</span> <span class="o">=</span> <span class="s2">&quot;1KG/small_1KG.vcf.gz&quot;</span>
    <span class="n">_thousand_genome_tbi</span> <span class="o">=</span> <span class="s2">&quot;1KG/small_1KG.vcf.gz.tbi&quot;</span>

    <span class="n">_gtc_pattern</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{Sample_ID}</span><span class="s2">.gtc&quot;</span>
    <span class="n">_idat_red_pattern</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{SentrixBarcode_A}</span><span class="s2">_</span><span class="si">{SentrixPosition_A}</span><span class="s2">_Red.idat&quot;</span>
    <span class="n">_idat_green_pattern</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{SentrixBarcode_A}</span><span class="s2">_</span><span class="si">{SentrixPosition_A}</span><span class="s2">_Grn.idat&quot;</span>

    <span class="n">_ped</span> <span class="o">=</span> <span class="s2">&quot;plink/samples.ped&quot;</span>
    <span class="n">_map</span> <span class="o">=</span> <span class="s2">&quot;plink/samples.map&quot;</span>

    <span class="n">_bed</span> <span class="o">=</span> <span class="s2">&quot;plink/samples.bed&quot;</span>
    <span class="n">_bim</span> <span class="o">=</span> <span class="s2">&quot;plink/samples.bim&quot;</span>
    <span class="n">_fam</span> <span class="o">=</span> <span class="s2">&quot;plink/samples.fam&quot;</span>

    <span class="n">_test_gtc</span> <span class="o">=</span> <span class="s2">&quot;illumina/gtc/small_genotype.gtc&quot;</span>
    <span class="n">_test_idat</span> <span class="o">=</span> <span class="s2">&quot;illumina/idat/small_intensity.idat&quot;</span>

    <span class="n">_snp_array</span> <span class="o">=</span> <span class="s2">&quot;Fake-GSA&quot;</span>
    <span class="n">_num_snps</span> <span class="o">=</span> <span class="mi">2_000</span>

    <span class="n">_subject_id_column</span> <span class="o">=</span> <span class="s2">&quot;LIMS_Individual_ID&quot;</span>
    <span class="n">_expected_sex_column</span> <span class="o">=</span> <span class="s2">&quot;Expected_Sex&quot;</span>
    <span class="n">_case_control_column</span> <span class="o">=</span> <span class="s2">&quot;Case/Control_Status&quot;</span>

    <span class="k">def</span> <span class="nf">add_user_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_point</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bed&quot;</span><span class="p">,</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">U</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">copy</span><span class="p">)</span> <span class="ow">and</span> <span class="n">entry_point</span> <span class="o">==</span> <span class="s2">&quot;gtc&quot;</span><span class="p">:</span>
            <span class="c1"># TestData only has 1 GTC file that I copy multiple times to</span>
            <span class="c1"># simulate samples. So this entry point must be copied into the</span>
            <span class="c1"># working directory.</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Test GTC files must be copied to the working directory.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_user_files</span><span class="p">(</span><span class="n">entry_point</span><span class="p">,</span> <span class="n">copy</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_gtcs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_gtc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gtc_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">r</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_add_idats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_idat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idat_red_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">r</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_idat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idat_green_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">r</span><span class="p">)))</span></div>


<span class="k">def</span> <span class="nf">_make_cgr_cache</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create cache folder.&quot;&quot;&quot;</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;cgr_gwas_qc/&quot;</span> <span class="o">+</span> <span class="n">name</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XDG_CACHE_HOME&quot;</span><span class="p">):</span>
        <span class="n">_cache_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;XDG_CACHE_HOME&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">suffix</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_cache_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="s2">&quot;.cache&quot;</span> <span class="o">/</span> <span class="n">suffix</span>

    <span class="n">_cache_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_cache_path</span>


<div class="viewcode-block" id="RealData"><a class="viewcode-back" href="../../../dev_docs/testing.html#cgr_gwas_qc.testing.data.RealData">[docs]</a><span class="k">class</span> <span class="nc">RealData</span><span class="p">(</span><span class="n">DataRepo</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A repository of real data stored on cgems.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; cache = ReadData(working_dir, sync=True)  # automatically symlink (on cgems) or rsync data locally</span>

<span class="sd">        &gt;&gt;&gt; cache / existing_file.txt  # If file exists then returns path to the file</span>
<span class="sd">        Path(&quot;../../../.cache/cgr_gwas_qc/test_data/existing_file.txt&quot;)</span>

<span class="sd">        &gt;&gt;&gt; cache / non_existing_file.txt  # If file does not exist then raises exception</span>
<span class="sd">        FileNotFoundError: &quot;../../../.cache/cgr_gwas_qc/test_data/non_existing_file.txt&quot;</span>

<span class="sd">        &gt;&gt;&gt; cache.make_cgr_sample_sheet()  # copy sample sheet to working dir</span>
<span class="sd">        &gt;&gt;&gt; cache.add_user_files(copy=False)  # add full path of user files to config</span>
<span class="sd">        &gt;&gt;&gt; cache.make_config()  # make the config for files added using cache</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_data_type</span> <span class="o">=</span> <span class="s2">&quot;Real Data&quot;</span>
    <span class="n">_data_path</span> <span class="o">=</span> <span class="n">_make_cgr_cache</span><span class="p">(</span><span class="s2">&quot;test_data&quot;</span><span class="p">)</span>

    <span class="n">_sample_sheet</span> <span class="o">=</span> <span class="s2">&quot;original_data/manifest_short.csv&quot;</span>

    <span class="n">_illumina_manifest_file</span> <span class="o">=</span> <span class="s2">&quot;reference_data/GSAMD-24v1-0_20011747_A1.bpm&quot;</span>
    <span class="n">_thousand_genome_vcf</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;reference_data/ALL.wgs.phase3_shapeit2_mvncall_integrated_v5.20130502.sites.vcf.gz&quot;</span>
    <span class="p">)</span>
    <span class="n">_thousand_genome_tbi</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;reference_data/ALL.wgs.phase3_shapeit2_mvncall_integrated_v5.20130502.sites.vcf.gz.tbi&quot;</span>
    <span class="p">)</span>

    <span class="n">_gtc_pattern</span> <span class="o">=</span> <span class="s2">&quot;original_data/</span><span class="si">{SentrixBarcode_A}</span><span class="s2">_</span><span class="si">{SentrixPosition_A}</span><span class="s2">.gtc&quot;</span>
    <span class="n">_idat_red_pattern</span> <span class="o">=</span> <span class="s2">&quot;original_data/</span><span class="si">{SentrixBarcode_A}</span><span class="s2">_</span><span class="si">{SentrixPosition_A}</span><span class="s2">_Red.idat&quot;</span>
    <span class="n">_idat_green_pattern</span> <span class="o">=</span> <span class="s2">&quot;original_data/</span><span class="si">{SentrixBarcode_A}</span><span class="s2">_</span><span class="si">{SentrixPosition_A}</span><span class="s2">_Grn.idat&quot;</span>

    <span class="n">_ped</span> <span class="o">=</span> <span class="s2">&quot;production_outputs/plink_start/samples.ped&quot;</span>
    <span class="n">_map</span> <span class="o">=</span> <span class="s2">&quot;production_outputs/plink_start/samples.map&quot;</span>

    <span class="n">_bed</span> <span class="o">=</span> <span class="s2">&quot;production_outputs/plink_start/samples.bed&quot;</span>
    <span class="n">_bim</span> <span class="o">=</span> <span class="s2">&quot;production_outputs/plink_start/samples.bim&quot;</span>
    <span class="n">_fam</span> <span class="o">=</span> <span class="s2">&quot;production_outputs/plink_start/samples.fam&quot;</span>

    <span class="n">_snp_array</span> <span class="o">=</span> <span class="s2">&quot;GSAMD-24v1-0&quot;</span>
    <span class="n">_num_snps</span> <span class="o">=</span> <span class="mi">700078</span>

    <span class="n">_subject_id_column</span> <span class="o">=</span> <span class="s2">&quot;PI_Subject_ID&quot;</span>
    <span class="n">_expected_sex_column</span> <span class="o">=</span> <span class="s2">&quot;Expected_Sex&quot;</span>
    <span class="n">_case_control_column</span> <span class="o">=</span> <span class="s2">&quot;Case/Control_Status&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">working_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">full_sample_sheet</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">sync</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">GRCh_version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">37</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A real test data repository of ~200 samples.</span>

<span class="sd">        These data are stored on cgems. If you are running this on a computer</span>
<span class="sd">        with access to cgems then providing ``sync=True`` will rsync the data</span>
<span class="sd">        into a local cache. If you are running this on cgems then</span>
<span class="sd">        ``sync=True`` will create a symlink into the cache folder.</span>

<span class="sd">        Args:</span>
<span class="sd">            sync: If True we will try to cache data locally [Default False].</span>
<span class="sd">            GRCh_version: Which version of the human genome to use [Default</span>
<span class="sd">              37]. If it is 38 then override the Illumina manifest and thousand</span>
<span class="sd">              genomes files.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">full_sample_sheet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sample_sheet</span> <span class="o">=</span> <span class="s2">&quot;original_data/manifest_full.csv&quot;</span>

        <span class="k">if</span> <span class="n">sync</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sync_data</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">GRCh_version</span> <span class="o">==</span> <span class="mi">38</span><span class="p">:</span>  <span class="c1"># Override reference file sto GRCh38</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;User files are still only available for GRCh37.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_illumina_manifest_file</span> <span class="o">=</span> <span class="s2">&quot;reference_data/GSAMD-24v1-0_20011747_A2.bpm&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thousand_genome_vcf</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;reference_data/ALL.wgs.shapeit2_integrated_v1a.GRCh38.20181129.sites.vcf.gz&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thousand_genome_tbi</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;reference_data/ALL.wgs.shapeit2_integrated_v1a.GRCh38.20181129.sites.vcf.gz.tbi&quot;</span>
            <span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">working_dir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_gtcs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">target_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">/</span> <span class="s2">&quot;original_data&quot;</span>
        <span class="n">target_folder</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span> <span class="o">/</span> <span class="s2">&quot;original_data&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.gtc&quot;</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">target_folder</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_idats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">target_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">/</span> <span class="s2">&quot;original_data&quot;</span>
        <span class="n">target_folder</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span> <span class="o">/</span> <span class="s2">&quot;original_data&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.idat&quot;</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">target_folder</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_sync_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Symlink or Rsync data to cache folder.&quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TEST_DATA_USER&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;USER&quot;</span><span class="p">)</span>
        <span class="n">server</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TEST_DATA_SERVER&quot;</span><span class="p">,</span> <span class="n">DEFAULT_TEST_DATA_SERVER</span><span class="p">)</span>
        <span class="n">remote_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TEST_DATA_PATH&quot;</span><span class="p">,</span> <span class="n">DEFAULT_TEST_DATA_PATH</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">remote_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Rsync from remote server</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;rsync&quot;</span><span class="p">,</span>
                <span class="s2">&quot;-aL&quot;</span><span class="p">,</span>
                <span class="s2">&quot;--exclude=.snakemake&quot;</span><span class="p">,</span>
                <span class="s2">&quot;--exclude=logs&quot;</span><span class="p">,</span>
                <span class="s2">&quot;--exclude=gwas_qc_log.*&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">remote_path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span> <span class="n">executable</span><span class="o">=</span><span class="s2">&quot;/bin/bash&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">SubprocessError</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not connect to </span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">. To &quot;</span>
                <span class="s2">&quot;change set the environmental variable `TEST_DATA_USER`, &quot;</span>
                <span class="s2">&quot;`TEST_DATA_SERVER`, and `TEST_DATA_PATH.&quot;</span>
            <span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Leidos Biomedical Research, Inc.

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>