

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Working with Test Suite &mdash; GwasQcPipeline 1.6.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="API Reference" href="../api/cgr_gwas_qc.html" />
    <link rel="prev" title="Working with Source Code" href="source_code.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> GwasQcPipeline
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/installation.html">Installing GwasQcPipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/running_pipeline.html">Running the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/configuration.html">Configuration Files</a></li>
</ul>
<p><span class="caption-text">QC Sub Workflows</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../sub_workflows/entry_points.html">Entry Points Sub-workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sub_workflows/contamination.html">Contamination Sub-workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sub_workflows/sample_qc.html">Sample QC Sub-workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sub_workflows/subject_qc.html">Subject QC Sub-workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sub_workflows/delivery.html">Delivery Sub-workflow</a></li>
</ul>
<p><span class="caption-text">User Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/file_types.html">File Type Reference</a></li>
</ul>
<p><span class="caption-text">Developer Reference</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="setup.html">Development Environment Set-up</a></li>
<li class="toctree-l1"><a class="reference internal" href="documentation.html">Working with Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="source_code.html">Working with Source Code</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Working with Test Suite</a></li>
</ul>
<p><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/cgr_gwas_qc.html">API Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">GwasQcPipeline</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Working with Test Suite</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/dev_docs/testing.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <section id="working-with-test-suite">
<h1>Working with Test Suite<a class="headerlink" href="#working-with-test-suite" title="Permalink to this headline">¶</a></h1>
<p>Software testing is a technique where you isolate different parts of a system and test specific functionality.
Testing in bioinformatics is challenging because we often need large amounts of data.
We used a test driven approach and use both unit tests (tests targeting 1 specific piece of functionality) and integration tests (test targeting many steps at once).
Where possible we used very small “fake” datasets to ensure the test suite runs quickly.
However, much of the workflow could only be tested using real data.
We do not currently distribute our real test data but we have made the test suite module so that all developers can at least run the fake data tests.
We are using the powerful <a class="reference external" href="https://docs.pytest.org/en/6.2.x/">pytest</a> to orchestrate running of our tests.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>.
└──<span class="w"> </span>tests
<span class="w">   </span>├──<span class="w"> </span>__init__.py
<span class="w">   </span>├──<span class="w"> </span>cli/
<span class="w">   </span>├──<span class="w"> </span>cluster_profiles/
<span class="w">   </span>├──<span class="w"> </span>conftest.py
<span class="w">   </span>├──<span class="w"> </span>data/<span class="w">                                </span><span class="c1"># This is a git submodule pointing to our fake test data at https://github.com/NCI-CGR/GwasQcPipeline-test-data</span>
<span class="w">   </span>├──<span class="w"> </span>models/
<span class="w">   </span>├──<span class="w"> </span>parsers/
<span class="w">   </span>├──<span class="w"> </span>reporting/
<span class="w">   </span>├──<span class="w"> </span>test_config.py
<span class="w">   </span>├──<span class="w"> </span>test_snakemake_job_grouping.py
<span class="w">   </span>├──<span class="w"> </span>testing/
<span class="w">   </span>├──<span class="w"> </span>validators/
<span class="w">   </span>└──<span class="w"> </span>workflow/
</pre></div>
</div>
<p>Notice that the <code class="docutils literal notranslate"><span class="pre">test/</span></code> structure closely mimics the <code class="docutils literal notranslate"><span class="pre">src/cgr_gwas_qc/</span></code> structure.
<a class="reference external" href="https://docs.pytest.org/en/6.2.x/">pytest</a> requires a few naming conventions.</p>
<ol class="arabic simple">
<li><p>Any file that contains tests must be named <code class="docutils literal notranslate"><span class="pre">test_*.py</span></code></p></li>
<li><p>Any test function must be named <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">test_*()</span></code></p></li>
<li><p>There is a special file <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> that is shared by all of the test files.
The file <code class="docutils literal notranslate"><span class="pre">tests/conftest.py</span></code> is available to all tests.
While a file <code class="docutils literal notranslate"><span class="pre">tests/cli/conftest.py</span></code> would be available to all tests in the <code class="docutils literal notranslate"><span class="pre">tests/cli</span></code> folder and subdirectories.</p></li>
</ol>
<p><a class="reference external" href="https://docs.pytest.org/en/6.2.x/">pytest</a> also uses a concept called <code class="docutils literal notranslate"><span class="pre">fixtures</span></code>, where you can define a function that generates some data/state and then use the return value in your tests.
For example,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">one</span><span class="p">():</span>
   <span class="k">return</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">test_addition</span><span class="p">(</span><span class="n">one</span><span class="p">):</span>
   <span class="k">assert</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">one</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>
<p>In this simple example, we create a fixture <code class="docutils literal notranslate"><span class="pre">one</span></code> that returns the number <code class="docutils literal notranslate"><span class="pre">1</span></code>.
Our test function <code class="docutils literal notranslate"><span class="pre">test_addition</span></code> has the fixture name as one of its parameters.
<a class="reference external" href="https://docs.pytest.org/en/6.2.x/">pytest</a> will replace the fixture name with the return value so you can use it directly as a variable in your test.
I use <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> as a way to store and share fixtures among tests.</p>
<section id="fake-data">
<h2>Fake Data<a class="headerlink" href="#fake-data" title="Permalink to this headline">¶</a></h2>
<p>Our “fake” test data is stored at <a class="reference external" href="https://github.com/NCI-CGR/GwasQcPipeline-test-data">https://github.com/NCI-CGR/GwasQcPipeline-test-data</a>.
We have this repository as a git submodule in the test directory.
So if you followed <a class="reference internal" href="setup.html#dev-setup"><span class="std std-ref">Development Environment Set-up</span></a> where we <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">--recursive</span></code> you already have this data at <code class="docutils literal notranslate"><span class="pre">tests/data/</span></code>.</p>
<p>To run all tests that use these data simply:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pytest
</pre></div>
</div>
<p>You will notice the use of <code class="docutils literal notranslate"><span class="pre">FakeData()</span></code> in our test cases.
This is a helper class for providing the correct paths to our test data.
See the <code class="docutils literal notranslate"><span class="pre">cgr_gwas_qc.testing.data</span></code> module for more information.</p>
<dl class="py class">
<dt id="cgr_gwas_qc.testing.data.FakeData">
<em class="property">class </em><code class="sig-prename descclassname">cgr_gwas_qc.testing.data.</code><code class="sig-name descname">FakeData</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">working_dir</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>pathlib.Path<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/cgr_gwas_qc/testing/data.html#FakeData"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#cgr_gwas_qc.testing.data.FakeData" title="Permalink to this definition">¶</a></dt>
<dd><p>A repository of synthetic data stored in <code class="docutils literal notranslate"><span class="pre">tests/data</span></code>.</p>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span> <span class="o">=</span> <span class="n">FakeData</span><span class="p">(</span><span class="n">working_dir</span><span class="p">)</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span> <span class="o">/</span> <span class="n">existing_file</span><span class="o">.</span><span class="n">txt</span>  <span class="c1"># If file exists then returns path to the file</span>
<span class="go">Path(&quot;.../existing_file.txt&quot;)</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span> <span class="o">/</span> <span class="n">non_existing_file</span><span class="o">.</span><span class="n">txt</span>  <span class="c1"># If file does not exist then raises exception</span>
<span class="go">FileNotFoundError: &quot;.../non_existing_file.txt&quot;</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">make_cgr_sample_sheet</span><span class="p">()</span>  <span class="c1"># copy sample sheet to working dir</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">add_user_files</span><span class="p">()</span>  <span class="c1"># add BED/BIM/FAM to working dir</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">make_config</span><span class="p">()</span>  <span class="c1"># make the config for files added using cache</span>
</pre></div>
</div>
</dd></dl>

</section>
<section id="real-data">
<h2>Real Data<a class="headerlink" href="#real-data" title="Permalink to this headline">¶</a></h2>
<p>We also have small set real data stored on CGEMs/CCAD at <code class="docutils literal notranslate"><span class="pre">/DCEG/CGF/Bioinformatics/Production/data/cgr_gwas_qc</span></code>.
We do not distribute this data publicly but CGR users can sync this data to other NIH computers/servers using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cgr_gwas_qc.testing.data</span> <span class="kn">import</span> <span class="n">RealData</span>

<span class="n">RealData</span><span class="p">(</span><span class="n">sync</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>This will rsync the real data to <code class="docutils literal notranslate"><span class="pre">&lt;path</span> <span class="pre">to</span> <span class="pre">cloned</span> <span class="pre">version</span> <span class="pre">of</span> <span class="pre">repository&gt;/.cache/cgr_gwas_qc/test_data</span></code>.
If down the road CGR shares this data with other users then they can save the data on their own internal server.
Then users would need to set the environmental variables <code class="docutils literal notranslate"><span class="pre">TEST_DATA_USER</span></code>, <code class="docutils literal notranslate"><span class="pre">TEST_DATA_SERVER</span></code>, and <code class="docutils literal notranslate"><span class="pre">TEST_DATA_PATH</span></code> to replicate the rsync capabilities.</p>
<p>To run all tests, including those with real data, simply:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pytest --real-data
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You will see the use of <code class="docutils literal notranslate"><span class="pre">&#64;pytest.mark.real_data</span></code> as a decorator on test functions.
For example,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">real_data</span>
<span class="k">def</span> <span class="nf">test_addition</span><span class="p">():</span>
   <span class="k">pass</span>
</pre></div>
</div>
<p>This tells <a class="reference external" href="https://docs.pytest.org/en/6.2.x/">pytest</a> that this test uses real data and should be skipped unless the <code class="docutils literal notranslate"><span class="pre">--real-data</span></code> flag is given.</p>
</aside>
<dl class="py class">
<dt id="cgr_gwas_qc.testing.data.RealData">
<em class="property">class </em><code class="sig-prename descclassname">cgr_gwas_qc.testing.data.</code><code class="sig-name descname">RealData</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">working_dir</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>pathlib.Path<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">full_sample_sheet</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">True</span></em>, <em class="sig-param"><span class="n">sync</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">False</span></em>, <em class="sig-param"><span class="n">GRCh_version</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="default_value">37</span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/cgr_gwas_qc/testing/data.html#RealData"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#cgr_gwas_qc.testing.data.RealData" title="Permalink to this definition">¶</a></dt>
<dd><p>A repository of real data stored on cgems.</p>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span> <span class="o">=</span> <span class="n">ReadData</span><span class="p">(</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">sync</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># automatically symlink (on cgems) or rsync data locally</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span> <span class="o">/</span> <span class="n">existing_file</span><span class="o">.</span><span class="n">txt</span>  <span class="c1"># If file exists then returns path to the file</span>
<span class="go">Path(&quot;../../../.cache/cgr_gwas_qc/test_data/existing_file.txt&quot;)</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span> <span class="o">/</span> <span class="n">non_existing_file</span><span class="o">.</span><span class="n">txt</span>  <span class="c1"># If file does not exist then raises exception</span>
<span class="go">FileNotFoundError: &quot;../../../.cache/cgr_gwas_qc/test_data/non_existing_file.txt&quot;</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">make_cgr_sample_sheet</span><span class="p">()</span>  <span class="c1"># copy sample sheet to working dir</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">add_user_files</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># add full path of user files to config</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">make_config</span><span class="p">()</span>  <span class="c1"># make the config for files added using cache</span>
</pre></div>
</div>
</dd></dl>

</section>
</section>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../api/cgr_gwas_qc.html" class="btn btn-neutral float-right" title="API Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="source_code.html" class="btn btn-neutral float-left" title="Working with Source Code" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Leidos Biomedical Research, Inc.

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>